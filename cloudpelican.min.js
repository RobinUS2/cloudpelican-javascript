/**
 * CloudPelican javascript library
 * @version 0.4
 * @author Robin Verlangen
 */
cloudpelican={config:{token:"",write_interval_ms:200,deduplication:true,listeners:{window_error:true,console_log:true,console_error:true,console_warn:true,console_debug:true,console_trace:true},max_msg_length:512,compression:true,endpoint:"https://api.cloudpelican.com/api/push/",init_passed:false},_oldListeners:{},_compress:function(e){"use strict";var t,n={},r,i,s="",o=[],u=256;for(t=0;t<256;t+=1){n[String.fromCharCode(t)]=t}for(t=0;t<e.length;t+=1){r=e.charAt(t);i=s+r;if(n.hasOwnProperty(i)){s=i}else{o.push(n[s]);n[i]=u++;s=String(r)}}if(s!==""){o.push(n[s])}return o.join(",")},_applyOldListener:function(e,t,n){var r=cloudpelican._oldListeners[e];if(typeof r==="function"){return r.apply(t,n)}return false},init:function(e){if(typeof e!=="undefined"&&e!==null&&e.length>0){cloudpelican.config.token=e}if(cloudpelican.config.token.length===0){console.error("CLOUDPELICAN: Please fill in your API token");return false}if(cloudpelican.config.listeners.window_error===true){cloudpelican._oldListeners["window_error"]=window.onerror;window.onerror=function(){try{var e=arguments[0];cloudpelican.log(e,true,{url:arguments[1],line:arguments[2]})}catch(t){}return cloudpelican._applyOldListener("window_error",window,arguments)}}if(cloudpelican.config.listeners.console_log===true){cloudpelican._oldListeners["console_log"]=console.log;console.log=function(){try{var e=arguments[0];cloudpelican.log(e,false)}catch(t){}return cloudpelican._applyOldListener("console_log",console,arguments)}}if(cloudpelican.config.listeners.console_error===true){cloudpelican._oldListeners["console_error"]=console.error;console.error=function(){try{var e=arguments[0];cloudpelican.log(e,true)}catch(t){}return cloudpelican._applyOldListener("console_error",console,arguments)}}if(cloudpelican.config.listeners.console_warn===true){cloudpelican._oldListeners["console_warn"]=console.warn;console.warn=function(){try{var e=arguments[0];cloudpelican.log(e,true)}catch(t){}return cloudpelican._applyOldListener("console_warn",console,arguments)}}if(cloudpelican.config.listeners.console_debug===true){cloudpelican._oldListeners["console_debug"]=console.debug;console.debug=function(){try{var e=arguments[0];cloudpelican.log(e,false)}catch(t){}return cloudpelican._applyOldListener("console_debug",console,arguments)}}if(cloudpelican.config.listeners.console_trace===true){cloudpelican._oldListeners["console_trace"]=console.trace;console.trace=function(){try{var e=arguments[0];cloudpelican.log(e,false)}catch(t){}return cloudpelican._applyOldListener("console_trace",console,arguments)}}cloudpelican.config.init_passed=true;return cloudpelican.config.init_passed},log:function(e,t,n){if(typeof e==="undefined"||e===null||e.length===0){return false}if(e.indexOf("CLOUDPELICAN:")===0){return false}if(typeof e!=="string"){e=e.toString()}if(e.length>cloudpelican.config.max_msg_length){return false}if(cloudpelican.config.deduplication===true&&this._isDuplicate(e)){return false}var r={};r["msg"]=e;r["host"]=this._getHost();r["dt"]=this._getTime();if(typeof t!=="undefined"&&t===true){r["error"]="1"}if(typeof n!=="undefined"&&n!==null){for(var i in n){r[i]=n[i]}}var s={fields:r};this._write(s);return true},_getTime:function(){return Math.round(new Date)},_host:null,_getHost:function(){if(this._host===null){this._host=document.location.host.toString()}return this._host},_writeStack:[],_writeTimeout:null,_writeSequence:0,apiResponse:function(e){console.error("CLOUDPELICAN: "+e)},_previousMsg:null,_isDuplicate:function(e){if(this._previousMsg!==null&&e===this._previousMsg){return true}this._previousMsg=e;return false},_write:function(e){this._writeStack.push(e);if(this._writeTimeout===null){var t=function(){var t=cloudpelican._writeStack;cloudpelican._writeStack=[];cloudpelican._writeTimeout=null;cloudpelican._writeSequence++;var n=t.length===1?"single":"bulk";var r=cloudpelican.config.endpoint+n+"?js=1&t="+encodeURIComponent(cloudpelican.config.token);var s="";for(i in t){e=t[i];for(k in e.fields){val=e.fields[k];s+="&f";if(n==="bulk"){s+="["+i+"]"}s+="["+encodeURIComponent(k)+"]="+encodeURIComponent(val)}}var o=r+s;if(cloudpelican.config.compression===true){var u=cloudpelican._compress(s);if(s.length>u.length){var o=r+"&c="+u}}var a=document.createElement("script");a.async=true;a.defer=true;a.id="cloudpelican_"+cloudpelican._writeSequence;a.src=o;a.onload=function(e){document.body.removeChild(this)};document.body.appendChild(a)};this._writeTimeout=setTimeout(t,this.config.write_interval_ms)}return true}}
